<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <h1 id="info">Please allow access to your camera!</h1>
        <h1 id="infom"></h1>
    <div class="container">

        <div class="row">
                <div class="col-xs-12 col-sm-8">
                  <video id="webcam" style="display:none;" height="480" width="640"></video>
                  <div style=" width:640px;height:480px;margin: 10px auto;">
                      <canvas id="canvas" width="640" height="480"></canvas>
                      <div id="no_rtc" class="alert alert-error" style="display:none;"></div>
                      <div id="log" class="alert alert-info"></div>
                  </div>
                </div>
        </div>
    </div>




    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.min.js"></script>
    <!--  Open cv libs -->
    <script src="/js/build/jsfeat-min.js"></script>
    <script src="/js/dat.gui.js"></script>
    <script src="/js/profiler.js"></script>
    <script src="/js/compatibility.js"></script>
    <script src="/js/require.js"></script>

    <script>
    $(window).load(function() {
            "use strict";

            // lets do some fun
            var video = document.getElementById('webcam');
            var canvas = document.getElementById('canvas');
            try {
                var attempts = 0;
                var readyListener = function(event) {
                    findVideoSize();
                };
                var findVideoSize = function() {
                    if(video.videoWidth > 0 && video.videoHeight > 0) {
                        video.removeEventListener('loadeddata', readyListener);
                        onDimensionsReady(video.videoWidth, video.videoHeight);
                    } else {
                        if(attempts < 10) {
                            attempts++;
                            setTimeout(findVideoSize, 200);
                        } else {
                            onDimensionsReady(640, 480);
                        }
                    }
                };
                var onDimensionsReady = function(width, height) {
                    demo_app(width, height);
                    compatibility.requestAnimationFrame(tick);
                };

                video.addEventListener('loadeddata', readyListener);

                compatibility.getUserMedia({video: true}, function(stream) {
                    try {
                        video.src = compatibility.URL.createObjectURL(stream);
                    } catch (error) {
                        video.src = stream;
                    }
                    setTimeout(function() {
                            video.play();
                        }, 500);
                }, function (error) {
                    $('#canvas').hide();
                    $('#log').hide();
                    $('#no_rtc').html('<h4>WebRTC not available.</h4>');
                    $('#no_rtc').show();
                });
            } catch (error) {
                $('#canvas').hide();
                $('#log').hide();
                $('#no_rtc').html('<h4>Something goes wrong...</h4>');
                $('#no_rtc').show();
            }

            var stat = new profiler();

            var ctx,canvasWidth,canvasHeight;
            var img_u8, img_u8_warp, transform;

            function demo_app(videoWidth, videoHeight) {
                canvasWidth  = canvas.width;
                canvasHeight = canvas.height;
                ctx = canvas.getContext('2d');

                ctx.fillStyle = "rgb(0,255,0)";
                ctx.strokeStyle = "rgb(0,255,0)";

                img_u8 = new jsfeat.matrix_t(640, 480, jsfeat.U8_t | jsfeat.C1_t);
                img_u8_warp = new jsfeat.matrix_t(640, 480, jsfeat.U8_t | jsfeat.C1_t);
                transform = new jsfeat.matrix_t(3, 3, jsfeat.F32_t | jsfeat.C1_t);

                //xy original xy nueva
                jsfeat.math.perspective_4point_transform(transform, 0,   0,   0,  0,
                                                                    1280, 0,   640, 0,
                                                                    1280, 960, 640, 480,
                                                                    0,   960, 0, 480);
                jsfeat.matmath.invert_3x3(transform, transform);

                stat.add("grayscale");
                stat.add("warp perspective");
            }

            function tick() {
                compatibility.requestAnimationFrame(tick);
                stat.new_frame();
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    ctx.drawImage(video, 0, 0, 640, 480);
                    var imageData = ctx.getImageData(0, 0, 640, 480);

                    stat.start("grayscale");
                    jsfeat.imgproc.grayscale(imageData.data, 640, 480, img_u8);
                    stat.stop("grayscale");

                    stat.start("warp perspective");
                    jsfeat.imgproc.warp_perspective(img_u8, img_u8_warp, transform, 0);
                    stat.stop("warp perspective");

                    // render result back to canvas
                    var data_u32 = new Uint32Array(imageData.data.buffer);
                    var alpha = (0xff << 24);
                    var i = img_u8_warp.cols*img_u8_warp.rows, pix = 0;
                    while(--i >= 0) {
                        pix = img_u8_warp.data[i];
                        data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
                    }

                    ctx.putImageData(imageData, 0, 0);

                    $('#log').html(stat.log());
                }
            }

            $(window).unload(function() {
                video.pause();
                video.src=null;
            });
        });

  </script>
  </body>
</html>
